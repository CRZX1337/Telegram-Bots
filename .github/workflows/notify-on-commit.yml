name: Enhanced Commit Notification

on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Get all changed files across all commits in the push
      - name: Get all changed files
        id: changed-files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # GitHub automatically provides this token
        run: |
          # Safely parse the JSON data to extract commit IDs
          COMMITS_JSON=$(printf '%s' "${{ toJSON(github.event.commits) }}")
          COMMITS=$(echo "$COMMITS_JSON" | jq -r '.[].id')

          # Initialize counters
          TOTAL_ADDED=0
          TOTAL_MODIFIED=0
          TOTAL_REMOVED=0

          # Loop through each commit to aggregate file changes
          for COMMIT in $COMMITS; do
            DATA=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/commits/$COMMIT")
            
            # Count added/modified/removed files for this commit
            ADDED=$(echo "$DATA" | jq -r '.files[] | select(.status == "added") | .filename' | wc -l)
            MODIFIED=$(echo "$DATA" | jq -r '.files[] | select(.status == "modified") | .filename' | wc -l)
            REMOVED=$(echo "$DATA" | jq -r '.files[] | select(.status == "removed") | .filename' | wc -l)

            # Update totals
            TOTAL_ADDED=$((TOTAL_ADDED + ADDED))
            TOTAL_MODIFIED=$((TOTAL_MODIFIED + MODIFIED))
            TOTAL_REMOVED=$((TOTAL_REMOVED + REMOVED))
          done

          # Save totals as outputs
          echo "added=$TOTAL_ADDED" >> $GITHUB_OUTPUT
          echo "modified=$TOTAL_MODIFIED" >> $GITHUB_OUTPUT
          echo "removed=$TOTAL_REMOVED" >> $GITHUB_OUTPUT

      # Step 2: Send the detailed message to Telegram
      - name: Send detailed message
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "parse_mode=MarkdownV2" \
          -d "text=📌 **New Commit to \`${{ github.repository }}\`** 

          📂 **Files Changed**:  
          ➕ Added: ${{ steps.changed-files.outputs.added }}  
          ✏️ Modified: ${{ steps.changed-files.outputs.modified }}  
          🗑️ Removed: ${{ steps.changed-files.outputs.removed }}  

          🔗 [Compare Changes](${{ github.event.compare }})"
