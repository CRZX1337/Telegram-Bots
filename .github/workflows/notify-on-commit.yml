name: Enhanced Commit Notification

on: [push]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Get all changed files
        id: changed-files
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Hole alle Commits im aktuellen Push
          COMMITS=$(jq -r '.commits[].id' <<< "${{ toJSON(github.event.commits) }}")
          
          # Initialisiere ZÃ¤hler
          TOTAL_ADDED=0
          TOTAL_MODIFIED=0
          TOTAL_REMOVED=0

          # Iteriere Ã¼ber jeden Commit und sammle DateiÃ¤nderungen
          for COMMIT in $COMMITS; do
            DATA=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
              "https://api.github.com/repos/${{ github.repository }}/commits/$COMMIT")
            
            ADDED=$(jq -r '.files[] | select(.status == "added") | .filename' <<< "$DATA" | wc -l)
            MODIFIED=$(jq -r '.files[] | select(.status == "modified") | .filename' <<< "$DATA" | wc -l)
            REMOVED=$(jq -r '.files[] | select(.status == "removed") | .filename' <<< "$DATA" | wc -l)
            
            TOTAL_ADDED=$((TOTAL_ADDED + ADDED))
            TOTAL_MODIFIED=$((TOTAL_MODIFIED + MODIFIED))
            TOTAL_REMOVED=$((TOTAL_REMOVED + REMOVED))
          done

          # Speichere die Gesamtanzahlen
          echo "::set-output name=added::$TOTAL_ADDED"
          echo "::set-output name=modified::$TOTAL_MODIFIED"
          echo "::set-output name=removed::$TOTAL_REMOVED"

      - name: Send detailed message
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
          -d "parse_mode=MarkdownV2" \
          -d "text=ðŸ“Œ **New Commit to \`${{ github.repository }}\`** 

          ðŸ“‚ **Files Changed**:  
          âž• Added: ${{ steps.changed-files.outputs.added }}  
          âœï¸ Modified: ${{ steps.changed-files.outputs.modified }}  
          ðŸ—‘ï¸ Removed: ${{ steps.changed-files.outputs.removed }}  

          ðŸ”— [Compare Changes](${{ github.event.compare }})"
